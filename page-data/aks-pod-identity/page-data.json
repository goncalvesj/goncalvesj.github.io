{"componentChunkName":"component---src-templates-post-js","path":"/aks-pod-identity","result":{"data":{"markdownRemark":{"html":"<p>One of the things I was meaning to try out for some time was Azure Managed Identities in AKS clusters.</p>\n<p>I was always a fan of Managed Identities, I started using them in Azure App Services as soon as they were released in preview and became convinced straight away.</p>\n<p>Azure Managed Identities to me is something should be used in projects as much as possible, mostly because:</p>\n<ul>\n<li>Increases security of your applications</li>\n<li>No more sensitive information in source control and configuration files</li>\n</ul>\n<p>I already had an AKS cluster up an running for my own projects so the only things that was missing was setting up the pod identities to connect to Azure AD and get tokens.</p>\n<h2 id=\"create-an-aks-cluster\" style=\"position:relative;\"><a href=\"#create-an-aks-cluster\" aria-label=\"create an aks cluster permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create an AKS cluster</h2>\n<p>The first step is to create an AKS cluster with managed identities enable.</p>\n<p>The Azure portal allows for this today and it's a straight process.</p>\n<p>An alternative is to run a terraform script that takes care of this. Script here:</p>\n<p><strong><a href=\"https://github.com/goncalvesj/iac-templates/blob/master/TerraformTemplates/Azure.AKS/resources.tf\">https://github.com/goncalvesj/iac-templates/blob/master/TerraformTemplates/Azure.AKS/resources.tf</a></strong></p>\n<p>Once the cluster is created there is 1 new resource type of Managed Identity in the resource group.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 690px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a767a3d8c539b8787b4b4302a00a2781/3a737/aks-managed-identity.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.294797687861273%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABJ0AAASdAHeZh94AAAAbklEQVQI142Ouw6AIBAE+QRAOXygiYYcoaHh/79tlSvUGAuLySRbTFa5aUOjH1cxLSzYrocxBtZa8Zu2a63hvUfOGcyMGCOUBOcdFFiCd+Q79KQFiQgpJYk1K1ozOjecj9z16g/Ph6UU1FoRQsABo09LzkOTl5UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aks-managed-identity\"\n        title=\"aks-managed-identity\"\n        src=\"/static/a767a3d8c539b8787b4b4302a00a2781/1e043/aks-managed-identity.png\"\n        srcset=\"/static/a767a3d8c539b8787b4b4302a00a2781/991de/aks-managed-identity.png 173w,\n/static/a767a3d8c539b8787b4b4302a00a2781/e4d6b/aks-managed-identity.png 345w,\n/static/a767a3d8c539b8787b4b4302a00a2781/1e043/aks-managed-identity.png 690w,\n/static/a767a3d8c539b8787b4b4302a00a2781/3a737/aks-managed-identity.png 897w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"adding-aad-pod-identity-to-the-cluster\" style=\"position:relative;\"><a href=\"#adding-aad-pod-identity-to-the-cluster\" aria-label=\"adding aad pod identity to the cluster permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding AAD Pod Identity to the cluster</h2>\n<p>For this I looked at the steps outlined here:</p>\n<p><strong><a href=\"https://github.com/Azure/aad-pod-identity\">https://github.com/Azure/aad-pod-identity</a></strong></p>\n<p>I did the above with a small difference, I used the existing Managed Identity and didn't create a new one.</p>\n<p>So my steps were the following (I did them in Azure Cloud Shell):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Deploy using Helm 3</span>\nhelm repo <span class=\"token function\">add</span> aad-pod-identity https://raw.githubusercontent.com/Azure/aad-pod-identity/master/charts\nhelm <span class=\"token function\">install</span> aad-pod-identity aad-pod-identity/aad-pod-identity\n\n<span class=\"token comment\"># Set up env vars</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">IDENTITY_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"goncalvesj-aks-agentpool\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">SUBSCRIPTION_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"xxxxx\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">RESOURCE_GROUP</span><span class=\"token operator\">=</span><span class=\"token string\">\"xxxxx\"</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">IDENTITY_CLIENT_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>az identity show -g $RESOURCE_GROUP -n $IDENTITY_NAME --subscription $SUBSCRIPTION_ID --query clientId -otsv<span class=\"token variable\">)</span></span>\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">IDENTITY_RESOURCE_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>az identity show -g $RESOURCE_GROUP -n $IDENTITY_NAME --subscription $SUBSCRIPTION_ID --query <span class=\"token function\">id</span> -otsv<span class=\"token variable\">)</span></span>\"</span>\n\n<span class=\"token comment\"># Since the role assignent was created when the cluster was created</span>\n<span class=\"token comment\"># we only have to get the role assignment id</span>\n<span class=\"token comment\"># Look for the one where the principal name property is the same as the client id</span>\naz role assignment list -g <span class=\"token variable\">$RESOURCE_GROUP</span>\n\n<span class=\"token comment\"># Get the id and save as env var, should be similar to this</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">IDENTITY_ASSIGNMENT_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"/subscriptions/xxxxx/resourcegroups/xxxxx/providers/Microsoft.Authorization/roleAssignments/xxxxx\"</span></code></pre></div>\n<h2 id=\"deploy-azureidentity--azureidentitybinding-as-defined-in-the-github-repo\" style=\"position:relative;\"><a href=\"#deploy-azureidentity--azureidentitybinding-as-defined-in-the-github-repo\" aria-label=\"deploy azureidentity  azureidentitybinding as defined in the github repo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy AzureIdentity &#x26; AzureIdentityBinding as defined in the github repo</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span>EOF <span class=\"token operator\">|</span> kubectl apply -f -\napiVersion: <span class=\"token string\">\"aadpodidentity.k8s.io/v1\"</span>\nkind: AzureIdentity\nmetadata:\n  name: <span class=\"token variable\">$IDENTITY_NAME</span>\nspec:\n  type: <span class=\"token number\">0</span>\n  resourceID: <span class=\"token variable\">$IDENTITY_RESOURCE_ID</span>\n  clientID: <span class=\"token variable\">$IDENTITY_CLIENT_ID</span>\nEOF\n\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span>EOF <span class=\"token operator\">|</span> kubectl apply -f -\napiVersion: <span class=\"token string\">\"aadpodidentity.k8s.io/v1\"</span>\nkind: AzureIdentityBinding\nmetadata:\n  name: <span class=\"token variable\">$IDENTITY_NAME</span>-binding\nspec:\n  azureIdentity: <span class=\"token variable\">$IDENTITY_NAME</span>\n  selector: <span class=\"token variable\">$IDENTITY_NAME</span>\nEOF</code></pre></div>\n<h2 id=\"testing\" style=\"position:relative;\"><a href=\"#testing\" aria-label=\"testing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Testing</h2>\n<p>For testing I created a .NET Core Worker Service with the following code.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>stoppingToken<span class=\"token punctuation\">.</span>IsCancellationRequested<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    _logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogInformation</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Worker running at: {time}\"</span><span class=\"token punctuation\">,</span> DateTimeOffset<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">try</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> secretClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SecretClient</span><span class=\"token punctuation\">(</span>\n                            <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Uri</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://xxxxx.vault.azure.net/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                            <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DefaultAzureCredential</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> secret <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> secretClient<span class=\"token punctuation\">.</span><span class=\"token function\">GetSecretAsync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Secret1\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">cancellationToken</span><span class=\"token punctuation\">:</span> stoppingToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        _logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogInformation</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"KV Secret: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">secret<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">.</span>Value</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogError</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Error:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">,</span> stoppingToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"deploy\" style=\"position:relative;\"><a href=\"#deploy\" aria-label=\"deploy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy</h2>\n<p>Deployed it to Docker Hub and then to the AKS cluster as a single pod.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span> EOF <span class=\"token operator\">|</span> kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: workerservice2\n  labels:\n    aadpodidbinding: <span class=\"token variable\">$IDENTITY_NAME</span>\nspec:\n  containers:\n  - name: workerservice2\n    image: goncalvesj/workerservice2:20200811134040\n  nodeSelector:\n    kubernetes.io/os: linux\nEOF</code></pre></div>\n<p>If all went well you should be able to see the secret being printed to the container logs with:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl logs workservice2 --follow</code></pre></div>\n<h3 id=\"credits-to-everyone-who-built-and-works-on-the-httpsgithubcomazureaad-pod-identity-and-made-a-guide-so-easy-to-follow\" style=\"position:relative;\"><a href=\"#credits-to-everyone-who-built-and-works-on-the-httpsgithubcomazureaad-pod-identity-and-made-a-guide-so-easy-to-follow\" aria-label=\"credits to everyone who built and works on the httpsgithubcomazureaad pod identity and made a guide so easy to follow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Credits to everyone who built and works on the <strong><a href=\"https://github.com/Azure/aad-pod-identity\">https://github.com/Azure/aad-pod-identity</a></strong> and made a guide so easy to follow</h3>\n<p><strong>Hope this helped! Reach out to me on twitter if you have any questions!</strong></p>","timeToRead":3,"excerpt":"One of the things I was meaning to try out for some time was Azure Managed Identities in AKS clusters. I was always a fan of Managed…","frontmatter":{"title":"Setting up AKS Pod Azure Managed Identities","cover":"https://unsplash.it/400/300/?random?BigTest","date":"2020-08-11T00:00:00.000Z","categories":["Azure","AKS"],"tags":["AKS","Azure"]},"fields":{"slug":"/aks-pod-identity","date":"August 10, 2020"}}},"pageContext":{"slug":"/aks-pod-identity","nexttitle":"Deleting an Azure B2C Tenant","nextslug":"/delete-ad-b-2-c-tenant","prevtitle":"Deploying a Gatsby blog in GitHub pages","prevslug":"/deploy-gatsby-github-pages"}}}